### 实验 9 根据材料编程

​	后面的课程中，需要通过这个实验而获得的编程经验。

【编程例题】在屏幕中间分别显示绿色、绿底红色、白底蓝色的字符串“welcome to masm!”

​	编程所需的知识通过阅读、分析下面的材料获得。

​	80×25 彩色字符模式显示缓冲区(以下简称显示缓冲区)的结构：

​	内存地址空间中，B8000H～BFFFFH 共 32KB 的空间，为 80×25 彩色字符模式的显示缓冲区。向这个地址空间写入数据，写入的内容将立即出现在显示器上。

​	在 80×25 彩色字符模式下，显示器可以显示 25 行，每行 80 个字符，每个字符可以有 256 种属性(背景色、前景色、闪烁、高亮等组合信息)。

​	这样，一个字符在显示缓冲区中就要占两个字节，分别存放字符的 ASCII 码和属性。80×25 模式下，一屏的内容在显示缓冲区中共 4000 个字节。

​	显示缓冲区分 8 页，每页 4KB(≈4000B)，显示器可以显示任意一页的内容。一般情况，显示第 0 页的内容。也就是说通常情况下，B8000H～B8F9FH 中的 4000 个字节的内容将出现在显示器上。

​	在一页显示缓冲区中:

```c++
偏移 000-09F 对应显示器上的第 1 行(80个字符占 160 个字节);
偏移 0A0-13F 对应显示器上的第 2 行;
偏移 140-1DF 对应显示器上的第 3 行;
```

​	依此类推，可知，偏移 F00-F9F 对应显示器上的第 25 行。

​	在一行中，一个字符占两个字节的存储空间(一个字)，低位字节存储字符的 ASCII 码，高位字节存储字符的属性。一行共有 80 个字符，占 160 个字节。

​	即在一行中:

```c++
00 ~ 01 单元对应显示器上的第 1 列;
02 ~ 03 单元对应显示器上的第 2 列;
04 ~ 05 单元对应显示器上的第 3 列;
```

​	依此类推，可知，9E~9F 单元对应显示器上的第 80 列。

​	例：在显示器的 0 行 0 列显示黑底绿色的字符串'ABCDEF'(A的 ASCII 码值为 41H，02H 表示黑底绿色)

显示缓冲区里的内容为:

```assembly
			00 01 02 03 04 05 06 07 08 09 0A 0B ... 9E 9F
B800:0000 	41 02 42 02 43 02 44 02 45 02 46 02 ··· ·· ··
.... ....
.... ....
B800:00A0 	·· ·· ·· ·· ·· ·· ·· ·· ·· ·· ·· ·· ·· ·· ··
```

​	可以看出，在显示缓冲区中，**偶地址存放字符，奇地址存放字符的颜色属性**。

​	一个在屏幕上显示的字符，具有前景(字符色)和背景(底色)两种颜色，字符还可以高亮度和闪烁的方式显示。**前景色、背景色、闪烁、高亮**等信息被记录在属性字节中。

​	属性字节的格式：

|      | 7        | 6    | 5    | 4    | 3        | 2           | 1           | 0           |
| ---- | -------- | ---- | ---- | ---- | -------- | ----------- | ----------- | ----------- |
| 含义 | BL       | R    | G    | B    | I        | R           | G           | B           |
|      | **闪烁** | 背景 | 背景 | 背景 | ==高亮== | <u>前景</u> | <u>前景</u> | <u>前景</u> |

R：红色  G：绿色  B：蓝色  

​	可以按位设置属性字节，从而配出各种不同的前景色和背景色。  

比如：

* 红底绿字，属性字节为：01000010B；  
* 红底闪烁绿字，属性字节为：11000010B；  
* 红底高亮绿字，属性字节为：01001010B；  
* 黑底白字，属性字节为：00000111B；  
* 白底蓝字，属性字节为：01110001B。  

​	例：在显示器的 0 行 0 列显示红底高亮闪烁绿色的字符串'ABCDEF'

（红底高亮闪烁绿色，属性字节为：11001010B，CAH）

显示缓冲区里的内容为：

```assembly
			00 01 02 03 04 05 06 07 08 09 0A 0B ... 9E 9F  
B800:0000 	41 CA 42 CA 43 CA 44 CA 45 CA 46 CA ... .. .. 
.... ....
.... ....
B800:00A0 	.. .. .. .. .. .. .. .. .. .. .. .. ... .. ..
```

注意，闪烁的效果必须在全屏 DOS 方式下才能看到。

解析：

​	①先写出字符属性：绿色 00000010B=02H、绿底红色 00100100B=24H、白底蓝色 01110001B=71H；

​	②然后写出字符 ASCII 码，“welcome to masm!”查看附注 0 的 ASCII 码对照表，可得该字符串的 ASCII 值：

​	77 65 6C 63 6F 6D 65 20 74 6F 20 6D 61 73 6D 21，但更简单的方法是直接在数据区 db 字符串“welcome to masm!”即可，编译器会自动将字符串转换成 ASCII 码。

​	③现在考虑打印位置，显示器可以一页可以打印 25 行 80 列，我们要打印 3 行字符串，所以居中位置 (25 - 3) / 2 = 11 行，从 11 行开始打印，而一页有 80 列，“welcome to masm!”为 16 列，居中位置为(80 - 16) / 2 = 32 列，这样就找到了写入显存的位置。

​	但是要转换成具体的位置，需要做一些计算：

​	第 11 行地址 = (11 - 1)×00A0H = 1600 = 0640H

​	第 32 列偏移 = (32 - 1)×0002H= 62 = 003EH

​	④写入数据如下

```assembly
			.. 62 63 64 65 66 67 68 69 6A 6B 6C 6D 6E 6F 70 71 72 73 74 75 76 77 78 79 7A 7B 7C 
B800:0640 	.. 77 02 65 02 6C 02 63 02 6F 02 6D 02 65 02 20 02 74 02 6F 02 20 02 6D 02 61 02 ...
B800:06E0	.. 77,24,65,24,6C,24,63,24,6F,24,6D,24,65,24,20,24,74,24,6F,24,20,24,6D,24,61,24 ...
B800:0780	.. 77,71,65,71,6C,71,63,71,6F,71,6D,71,65,71,20,71,74,71,6F,71,20,71,6D,71,61,71 ...
```

```assembly
;显存区应该写入的数据(16进制)
77,02,65,02,6C,02,63,02,6F,02,6D,02,65,02,20,02,74,02,6F,02,20,02,6D,02,61,02,73,02,6D,02,21,02
77,24,65,24,6C,24,63,24,6F,24,6D,24,65,24,20,24,74,24,6F,24,20,24,6D,24,61,24,73,24,6D,24,21,24
77,71,65,71,6C,71,63,71,6F,71,6D,71,65,71,20,71,74,71,6F,71,20,71,6D,71,61,71,73,71,6D,71,21,71
```

```assembly
assume cs:codesg
data segment
	db "welcome to masm!"
	db 3 dup (02H,24H,71H)
data ends

codesg segment
start:
	mov ax,data
	mov ds,ax				;ds定位数据区
	mov bx,0B800H			
	mov es,bx				;es定位显存区
	
	mov bx,067EH			;0640H+003EH=067EH
	mov si,0
	mov cx,16				;"welcome to masm!"共16个字符
s:
	mov al,[si]				;偶数位存数，一次读取一个字节的字符
	mov es:[bx],al			;由于每一行同一个相对位置的字母都是一样的，所以一次处理三个字母
	mov es:[bx+00A0H],al
	mov es:[bx+0140H],al
	
	mov ah,02h				;奇数位存字符属性，一次读取一个字节的字符属性
	mov es:[bx+1],ah		;由于每一行同一个相对位置的字符属性都是不一样的，所以要分开处理
	mov ah,24h
	mov es:[bx+00A1H],ah
	mov ah,71h
	mov es:[bx+0141H],ah
	
	inc si					;从数据区"welcome to masm!"一次取1字节
	add bx,2				;写回显存区一次循环处理2字节
	loop s
	
	mov ax,4c00h
	int 21h
codesg ends
end start
```

​	编译、连接上述程序，在 DosBox 中输入`cls`清屏，然后运行`lab9.exe`查看结果如下：

![9.10.2 程序运行结果](文档插图/9.10.2 程序运行结果.png)

<center style="color:#C0C0C0">图9.10.2 程序运行结果</center>



### 附注 0 学习工具

<center style="color:#C0C0C0">表 ASCII码对照表</center>

| ASCII值 | 十六进制 | 控制字符 | ASCII值 | 十六进制 | 控制字符 | ASCII值 | 十六进制 | 控制字符 | ASCII值 | 十六进制 | 控制字符 |
| :------ | -------- | :------- | :------ | -------- | :------- | :------ | -------- | :------- | :------ | -------- | :------- |
| 0       | 00H      | NUT      | 32      | 20H      | (space)  | 64      | 40H      | @        | 96      | 60H      | 、       |
| 1       | 01H      | SOH      | 33      | 21H      | !        | 65      | 41H      | A        | 97      | 61H      | a        |
| 2       | 02H      | STX      | 34      | 22H      | "        | 66      | 42H      | B        | 98      | 62H      | b        |
| 3       | 03H      | ETX      | 35      | 23H      | #        | 67      | 43H      | C        | 99      | 63H      | c        |
| 4       | 04H      | EOT      | 36      | 24H      | $        | 68      | 44H      | D        | 100     | 64H      | d        |
| 5       | 05H      | ENQ      | 37      | 25H      | %        | 69      | 45H      | E        | 101     | 65H      | e        |
| 6       | 06H      | ACK      | 38      | 26H      | &        | 70      | 46H      | F        | 102     | 66H      | f        |
| 7       | 07H      | BEL      | 39      | 27H      | ,        | 71      | 47H      | G        | 103     | 67H      | g        |
| 8       | 08H      | BS       | 40      | 28H      | (        | 72      | 48H      | H        | 104     | 68H      | h        |
| 9       | 09H      | HT       | 41      | 29H      | )        | 73      | 49H      | I        | 105     | 69H      | i        |
| 10      | 0AH      | LF       | 42      | 2AH      | *        | 74      | 4AH      | J        | 106     | 6AH      | j        |
| 11      | 0BH      | VT       | 43      | 2BH      | +        | 75      | 4BH      | K        | 107     | 6BH      | k        |
| 12      | 0CH      | FF       | 44      | 2CH      | ,        | 76      | 4CH      | L        | 108     | 6CH      | l        |
| 13      | 0DH      | CR       | 45      | 2DH      | -        | 77      | 4DH      | M        | 109     | 6DH      | m        |
| 14      | 0EH      | SO       | 46      | 2EH      | .        | 78      | 4EH      | N        | 110     | 6EH      | n        |
| 15      | 0FH      | SI       | 47      | 2FH      | /        | 79      | 4FH      | O        | 111     | 6FH      | o        |
| 16      | 10H      | DLE      | 48      | 30H      | 0        | 80      | 50H      | P        | 112     | 70H      | p        |
| 17      | 11H      | DCI      | 49      | 31H      | 1        | 81      | 51H      | Q        | 113     | 71H      | q        |
| 18      | 12H      | DC2      | 50      | 32H      | 2        | 82      | 52H      | R        | 114     | 72H      | r        |
| 19      | 13H      | DC3      | 51      | 33H      | 3        | 83      | 53H      | S        | 115     | 73H      | s        |
| 20      | 14H      | DC4      | 52      | 34H      | 4        | 84      | 54H      | T        | 116     | 74H      | t        |
| 21      | 15H      | NAK      | 53      | 35H      | 5        | 85      | 55H      | U        | 117     | 75H      | u        |
| 22      | 16H      | SYN      | 54      | 36H      | 6        | 86      | 56H      | V        | 118     | 76H      | v        |
| 23      | 17H      | TB       | 55      | 37H      | 7        | 87      | 57H      | W        | 119     | 77H      | w        |
| 24      | 18H      | CAN      | 56      | 38H      | 8        | 88      | 58H      | X        | 120     | 78H      | x        |
| 25      | 19H      | EM       | 57      | 39H      | 9        | 89      | 59H      | Y        | 121     | 79H      | y        |
| 26      | 1AH      | SUB      | 58      | 3AH      | :        | 90      | 5AH      | Z        | 122     | 7AH      | z        |
| 27      | 1BH      | ESC      | 59      | 3BH      | ;        | 91      | 5BH      | [        | 123     | 7BH      | {        |
| 28      | 1CH      | FS       | 60      | 3CH      | <        | 92      | 5CH      | /        | 124     | 7CH      | \|       |
| 29      | 1DH      | GS       | 61      | 3DH      | =        | 93      | 5DH      | ]        | 125     | 7DH      | }        |
| 30      | 1EH      | RS       | 62      | 3EH      | >        | 94      | 5EH      | ^        | 126     | 7EH      | `        |
| 31      | 1FH      | US       | 63      | 3FH      | ?        | 95      | 5FH      | _        | 127     | 7FH      | DEL      |
